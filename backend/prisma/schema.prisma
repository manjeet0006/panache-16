// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- CORE MODELS ---

model College {
  id         String  @id @default(uuid())
  name       String
  city       String
  isInternal Boolean @default(false) // True for YOUR college

  departments Department[]
  teams       Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id         String @id @default(uuid())
  name       String
  // ✅ REQ: One secret code for all events for this specific department
  secretCode String

  collegeId String
  college   College @relation(fields: [collegeId], references: [id])
  teams     Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, collegeId])
}

model Event {
  id          String        @id @default(uuid())
  name        String
  description String
  category    EventCategory

  // ✅ REQ: Different team sizes per event
  minPlayers Int @default(1)
  maxPlayers Int @default(1)

  allowOutside Boolean @default(false)

  eventPrice String @default("0")

  invites EventInvite[]
  teams   Team[]


  registrationRequests RegistrationRequest[]

  // ✅ Judging Setup
  judges   JudgeAssignment[]
  criteria String[]          @default(["General"]) // e.g. ["Creativity", "Technicality"]

  eventDate  DateTime? // ✅ Added: For sorting/calendar logic
  dateLabel  String? // ✅ Added: For "pleasant" display (e.g. "Feb 14, 10:00 AM")
  guidelines String[] // Guidelines array

  registrationOpen Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// --- REGISTRATION & CODES ---

model EventInvite {
  id   String @id @default(uuid())
  code String @unique // e.g., "EXT-5521"

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  isUsed Boolean @default(false)

  // Track the team that "consumed" this code
  usedByTeamId String? @unique
  usedByTeam   Team?   @relation(fields: [usedByTeamId], references: [id])
}

model Team {
  id       String @id @default(uuid())
  teamName String
  eventId  String
  event    Event  @relation(fields: [eventId], references: [id])

  collegeId String
  college   College @relation(fields: [collegeId], references: [id])

  // Internal teams link to Dept
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // External (or limited internal) teams link to Invite Code
  inviteId String?      @unique
  invite   EventInvite?

  // ✅ REQ: Payment Logic (Cloudinary)
  paymentStatus PaymentStatus @default(PENDING)
  paymentImage  String? // URL from Cloudinary
  transactionId String?

  // Razorpay Specific Fields
  razorpayOrderId   String? @unique
  razorpayPaymentId String? @unique
  razorpaySignature String?

  // ✅ REQ: QR Entry for Outside Students
  ticketCode String?    @unique // Only generated for external teams
  entryLogs  EntryLog[]

  members Member[]
  scores  Score[]

  createdAt DateTime @default(now())

  // Prevents a department from registering multiple times for the same event
  @@unique([eventId, departmentId])
}

model Member {
  id         String  @id @default(uuid())
  name       String
  enrollment String?
  phone      String
  isLeader   Boolean @default(false)

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])
}

// --- JUDGING & ENTRY TRACKING ---

model Judge {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String

  assignments JudgeAssignment[]
  scores      Score[]
}

model JudgeAssignment {
  id      String @id @default(uuid())
  judgeId String
  eventId String

  judge Judge @relation(fields: [judgeId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([judgeId, eventId])
}

model Score {
  id      String @id @default(uuid())
  teamId  String
  team    Team   @relation(fields: [teamId], references: [id])
  judgeId String
  judge   Judge  @relation(fields: [judgeId], references: [id])

  criteriaScores Json // Stores points like { "Creativity": 9, "Logic": 10 }
  totalPoints    Float
  comments       String?

  @@unique([teamId, judgeId])
}

model EntryLog {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  scannedAt DateTime @default(now())
  scannerId String // ID of the volunteer/admin scanning
  dayNumber Int // 1 to 7
  type      LogType // ENTRY or EXIT

  @@index([teamId, scannedAt(sort: Desc)])
}

model RegistrationRequest {
  id          String @id @default(uuid())
  name        String // Contact person name
  collegeName String
  phone       String
  email       String
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id])

  status    String   @default("PENDING") // PENDING, CONTACTED, CODE_SENT
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- ENUMS ---

enum LogType {
  ENTRY
  EXIT
}

enum EventCategory {
  PANACHE
  PRATISHTHA
  PRAGATI
}

enum InquiryStatus {
  PENDING
  CALLED
  CODE_SENT
  REGISTERED
  REJECTED
  CLOSED
}
