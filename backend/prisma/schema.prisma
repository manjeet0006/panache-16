// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- CORE MODELS ---

model College {
  id         String  @id @default(uuid())
  name       String
  city       String
  isInternal Boolean @default(false) // True for YOUR college

  departments Department[]
  teams       Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id         String @id @default(uuid())
  name       String
  // ✅ REQ: One secret code for all events for this specific department
  secretCode String

  collegeId String
  college   College @relation(fields: [collegeId], references: [id])
  teams     Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, collegeId])
}

model Event {
  id          String        @id @default(uuid())
  name        String
  description String
  category    EventCategory

  // ✅ REQ: Different team sizes per event
  minPlayers Int @default(1)
  maxPlayers Int @default(1)

  allowOutside Boolean @default(false)

  eventPrice String @default("0")

  invites EventInvite[]
  teams   Team[]

  registrationRequests RegistrationRequest[]

  // ✅ Judging Setup
  judges   JudgeAssignment[]
  criteria String[]          @default(["General"]) // e.g. ["Creativity", "Technicality"]

  eventDate  DateTime? // ✅ Added: For sorting/calendar logic
  dateLabel  String? // ✅ Added: For "pleasant" display (e.g. "Feb 14, 10:00 AM")
  guidelines String[] // Guidelines array

  registrationOpen Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// --- REGISTRATION & CODES ---

model EventInvite {
  id   String @id @default(uuid())
  code String @unique // e.g., "EXT-5521"

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  isUsed Boolean @default(false)

  // Track the team that "consumed" this code
  usedByTeamId String? @unique
  usedByTeam   Team?   @relation(fields: [usedByTeamId], references: [id])
}

model Team {
  id       String @id @default(uuid())
  teamName String
  eventId  String
  event    Event  @relation(fields: [eventId], references: [id])

  collegeId String
  college   College @relation(fields: [collegeId], references: [id])

  // Internal teams link to Dept
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // External (or limited internal) teams link to Invite Code
  inviteId String?      @unique
  invite   EventInvite?

  // ✅ REQ: Payment Logic (Cloudinary)
  paymentStatus PaymentStatus @default(PENDING)
  paymentImage  String? // URL from Cloudinary
  transactionId String?

  // Razorpay Specific Fields
  razorpayOrderId   String? @unique
  razorpayPaymentId String? @unique
  razorpaySignature String?

  // ✅ REQ: QR Entry for Outside Students
  ticketCode String?    @unique // Only generated for external teams
  entryLogs  EntryLog[]

  // // 2. Celebrity Night Code (NEW)
  // concertCode String? @unique
  // // Link to specific concert date (Optional, if you want to restrict them to Day 1 vs Day 2)
  // concertId   String?

  members Member[]
  scores  Score[]

  createdAt DateTime @default(now())

  // Prevents a department from registering multiple times for the same event
  @@unique([eventId, departmentId])
}

model Member {
  id         String  @id @default(uuid())
  name       String
  enrollment String?
  phone      String
  isLeader   Boolean @default(false)

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  entryLogs EntryLog[]
}

// --- JUDGING & ENTRY TRACKING ---

model Judge {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String

  assignments JudgeAssignment[]
  scores      Score[]
}

model JudgeAssignment {
  id      String @id @default(uuid())
  judgeId String
  eventId String

  judge Judge @relation(fields: [judgeId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([judgeId, eventId])
}

model Score {
  id      String @id @default(uuid())
  teamId  String
  team    Team   @relation(fields: [teamId], references: [id])
  judgeId String
  judge   Judge  @relation(fields: [judgeId], references: [id])

  criteriaScores Json // Stores points like { "Creativity": 9, "Logic": 10 }
  totalPoints    Float
  comments       String?

  @@unique([teamId, judgeId])
}

// 2. The Shared Entry Log (Tracks movement for EVERYONE)
model EntryLog {
  id        String   @id @default(uuid())
  scannedAt DateTime @default(now())
  scannerId String // ID of the volunteer scanning
  dayNumber Int // 1, 2, 3
  type      LogType // ENTRY or EXIT

  // ✅ OPTION A: It's a Team Member (Participant)
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  // ✅ OPTION B: It's a Concert Guest (New)
  concertTicketId String?
  concertTicket   ConcertTicket? @relation(fields: [concertTicketId], references: [id])

  // ✅ OPTION C: It's a specific Team Member
  memberId String?
  member   Member? @relation(fields: [memberId], references: [id])

  // Indexes for fast lookup
  @@index([teamId, scannedAt])
  @@index([concertTicketId, scannedAt])
  @@index([memberId, scannedAt])
}

model RegistrationRequest {
  id          String @id @default(uuid())
  name        String // Contact person name
  collegeName String
  phone       String
  email       String
  eventId     String
  event       Event  @relation(fields: [eventId], references: [id])

  status    String   @default("PENDING") // PENDING, CONTACTED, CODE_SENT
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- ENUMS ---

enum LogType {
  ENTRY
  EXIT
}

enum EventCategory {
  PANACHE
  PRATISHTHA
  PRAGATI
}

enum InquiryStatus {
  PENDING
  CALLED
  CODE_SENT
  REGISTERED
  REJECTED
  CLOSED
}

// ✅ NEW SECTION: CONCERT & INDIVIDUAL USERS

// 2. The Concert Event (Day 1, Day 2, etc.)
model Concert {
  id         String   @id @default(uuid())
  artistName String // e.g., "Arijit Singh"
  dayLabel   String // e.g., "Day 1 - Feb 12"
  date       DateTime
  imageUrl   String // URL to artist photo

  // Pricing config (Stored as JSON for flexibility)
  // Example: { "SILVER": 499, "GOLD": 999 }
  tierDetails ConcertTierDetails[]

  soldOut   Boolean         @default(false)
  tickets   ConcertTicket[]
  createdAt DateTime        @default(now())
}

model ConcertTierDetails {
  id          String     @id @default(uuid())
  concertId   String
  concert     Concert    @relation(fields: [concertId], references: [id])
  tier        TicketTier
  price       String
  ticketLimit Int
  ticketsSold Int        @default(0)

  @@unique([concertId, tier])
}

// 3. The Ticket Itself
model ConcertTicket {
  id String @id @default(uuid())

  // Guest Details
  guestName  String
  guestEmail String
  guestPhone String 

  concertId String
  concert   Concert @relation(fields: [concertId], references: [id])

  tier      TicketTier
  pricePaid String

  // ✅ FIX: Mark these as @unique to prevent duplicate tickets
  paymentId String   @unique
  orderId   String   @unique
  
  // ✅ FIX: Add Signature for security (audit trails)
  signature String?

  // DUAL QR CODES
  arenaCode String @unique
  isEnterArena    Boolean @default(false) // Tracks Celebrity Gate entry
  isEnterMainGate Boolean @default(false) // Tracks Main Gate entry (NEW)

  createdAt DateTime   @default(now())
  entryLogs EntryLog[]
}

enum TicketTier {
  SILVER
  GOLD
  PLATINUM
}
